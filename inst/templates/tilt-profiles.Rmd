---
title: "Running tilt profiles"
params:
  input: "~/Downloads/tilt/input"
  output: "~/Downloads/tilt/output"
  emissions_profile_any_companies: "emissions_profile_any_companies.csv"
  emissions_profile_products: "emissions_profile_products.csv"
  emissions_profile_upstream_products: "emissions_profile_upstream_products.csv"
  sector_profile_any_scenarios: "sector_profile_any_scenarios.csv"
  sector_profile_companies: "sector_profile_companies.csv"
  sector_profile_upstream_companies: "sector_profile_upstream_companies.csv"
  sector_profile_upstream_products: "sector_profile_upstream_products.csv"
  europages_companies: "europages_companies.csv"
  ecoinvent_activities: "ecoinvent_activities.csv"
  ecoinvent_europages: "ecoinvent_europages.csv"
  ecoinvent_inputs: "ecoinvent_inputs.csv"
  isic: "isic.csv"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This workflow creates the output of for all `profile*()` functions.

## Setup

```{r global}
library(dplyr, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(future)
library(fs)
library(tiltWorkflows)

# Create a path under ~/Downwloads/tilt/
tilt_path <- function(...) {
  path_home("Downloads", "tilt", ...)
}
# Read a .csv but if it doesnt' exist fall back to another dataset
read_csv_falling_back_to <- function(path, data) {
  if (file_exists(path)) {
    read_csv(path)
  } else {
    warning("Using ", deparse(substitute(data)), call. = FALSE)
    data
  }
}

# Enable computing over multiple workers in parallel
plan(multisession)
# Read data quietly, extend the width of printed datasets
options(readr.show_col_types = FALSE, width = 500)
# Create a folder to save results
dir_create(tilt_path("output"))
```

## Data

This example defaults to using toy datasets but you may [use the
parameters](https://2degreesinvesting.github.io/tiltWorkflows/articles/using-parameters.html)
of this file to instead use your own data.

```{r}
europages_companies <- path(params$input, params$europages_companies) |> 
  read_csv_falling_back_to(tiltIndicatorAfter::ep_companies) |>
  select(
    "company_name",
    "country",
    "company_city",
    "postcode",
    "address",
    "main_activity",
    "companies_id"
  )

ecoinvent_activities <- path(params$input, params$ecoinvent_activities) |> 
  read_csv_falling_back_to(tiltIndicatorAfter::ecoinvent_activities)

ecoinvent_europages <- path(params$input, params$ecoinvent_europages) |> 
  read_csv_falling_back_to(tiltIndicatorAfter::matches_mapper)

ecoinvent_inputs <- path(params$input, params$ecoinvent_inputs) |> 
  read_csv_falling_back_to(tiltIndicatorAfter::ecoinvent_inputs) |>
  select(
    "input_activity_uuid_product_uuid",
    "exchange_name",
    "exchange_unit_name"
  ) |>
  distinct()

isic <- path(params$input, params$isic) |> 
  read_csv_falling_back_to(tiltIndicatorAfter::isic_tilt_mapper)
```

## Emissions profile

```{r}
# Load data specific to this indicator
emissions_profile_any_companies <- path(params$input, params$emissions_profile_any_companies) |> 
  read_csv_falling_back_to(read_csv(toy_emissions_profile_any_companies()))
# FIXME User toy_emissions_profile_products_ecoinvent()
# See https://github.com/2DegreesInvesting/tiltToyData/pull/12
# https://github.com/2DegreesInvesting/tiltWorkflows/issues/9
emissions_profile_products <- path(params$input, params$emissions_profile_products) |> 
  read_csv_falling_back_to(read_csv(toy_emissions_profile_products()))

emissions_profile <- emissions_profile_any_companies |> 
  profile_emissions(
    co2 = emissions_profile_products,
    europages_companies = europages_companies,
    ecoinvent_activities = ecoinvent_activities,
    ecoinvent_europages = ecoinvent_europages,
    isic = isic,
    low_threshold = 1 / 3,
    high_threshold = 2 / 3
  )

emissions_profile |> 
  unnest_product() |> 
  write_csv(path(params$output, "emissions_profile_at_product_level.csv")) |> 
  print()

emissions_profile |> 
  unnest_company() |> 
  write_csv(path(params$output, "emissions_profile_at_company_level.csv")) |> 
  print()
```

## Emissions profile upstream

```{r}
# Load data specific to this indicator
# FIXME User toy_emissions_profile_upstream_products_ecoinvent()
# See https://github.com/2DegreesInvesting/tiltToyData/pull/12
# https://github.com/2DegreesInvesting/tiltWorkflows/issues/9
emissions_profile_upstream_products <- path(params$input, params$emissions_profile_upstream_products) |> 
  read_csv_falling_back_to(read_csv(toy_emissions_profile_upstream_products()))

# Create results at product and company level
emissions_profile_upstream <- emissions_profile_any_companies |>
  profile_emissions_upstream(
    co2 = emissions_profile_upstream_products,
    europages_companies = europages_companies,
    ecoinvent_activities = ecoinvent_activities,
    ecoinvent_inputs = ecoinvent_inputs,
    ecoinvent_europages = ecoinvent_europages,
    isic = isic,
    low_threshold = 1 / 3,
    high_threshold = 2 / 3
  )

emissions_profile_upstream |> 
  unnest_product() |> 
  write_csv(path(params$output, "emissions_profile_upstream_at_product_level.csv")) |> 
  print()

emissions_profile_upstream |> 
  unnest_company() |> 
  write_csv(path(params$output, "emissions_profile_upstream_at_company_level.csv")) |> 
  print()
```

## Sector profile

```{r}
# Load data specific to this indicator
sector_profile_companies <- path(params$input, params$sector_profile_companies) |> 
  read_csv_falling_back_to(read_csv(toy_sector_profile_companies()))

sector_profile_any_scenarios <- path(params$input, params$sector_profile_any_scenarios) |> 
  read_csv_falling_back_to(read_csv(toy_sector_profile_any_scenarios()))

# Create results at product and company level
sector_profile <- sector_profile_companies |> 
  profile_sector(
    sector_profile_any_scenarios,
    europages_companies = europages_companies,
    ecoinvent_activities = ecoinvent_activities,
    ecoinvent_europages = ecoinvent_europages,
    isic = isic,
    low_threshold = 1 / 3,
    high_threshold = 2 / 3
  )

sector_profile |> 
  unnest_product() |> 
  write_csv(path(params$output, "sector_profile_at_product_level.csv")) |> 
  print()

sector_profile |> 
  unnest_company() |> 
  write_csv(path(params$output, "sector_profile_at_company_level.csv")) |> 
  print()
```

## Sector profile upstream

```{r}
# Load data specific to this indicator
sector_profile_upstream_companies <-path(params$input, params$sector_profile_upstream_companies) |> 
read_csv_falling_back_to(read_csv(toy_sector_profile_upstream_companies()))

sector_profile_upstream_products <- path(params$input, params$sector_profile_upstream_products) |> 
  read_csv_falling_back_to(read_csv(toy_sector_profile_upstream_products()))

# Create results at product and company level
sector_profile_upstream <- sector_profile_upstream_companies |> 
  profile_with(profile_sector_upstream,
    sector_profile_any_scenarios,
    sector_profile_upstream_products,
    europages_companies = europages_companies,
    ecoinvent_activities = ecoinvent_activities,
    ecoinvent_inputs = ecoinvent_inputs,
    ecoinvent_europages = ecoinvent_europages,
    isic = isic,
    low_threshold = 1 / 3,
    high_threshold = 2 / 3
)

emissions_profile <- emissions_profile_any_companies |> 
  profile_with(profile_emissions,
    co2 = emissions_profile_products,
    europages_companies = europages_companies,
    ecoinvent_activities = ecoinvent_activities,
    ecoinvent_europages = ecoinvent_europages,
    isic = isic,
    low_threshold = 1 / 3,
    high_threshold = 2 / 3
  )



sector_profile_upstream |> 
  unnest_product() |> 
  write_csv(path(params$output, "sector_profile_upstream_at_product_level.csv")) |> 
  print()

sector_profile_upstream |> 
  unnest_company() |> 
  write_csv(path(params$output, "sector_profile_upstream_at_company_level.csv")) |> 
  print()
```

## Results

```{r}
dir_tree(tilt_path("output"))
```

## Cleanup

TODO
