---
title: "tilt workflow"
author: "Kalash Singhal"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  # FIXME when this file become reproducible
  eval = FALSE
)
```

The tiltIndicatorAfter_runner script uses the output from the
tiltIndicatorBefore package as the inputs to the tiltIndicator and
tiltIndicatorAfter packages. This script uses the CSV files from the
tiltIndicatorBefore package to create the final output of the four indicators.

## Setup

```{r}
library(dplyr, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
# devtools::install_github("2DegreesInvesting/tiltIndicatorAfter")
library(tiltIndicatorAfter)
```

## tiltIndicatorAfter data common for all indicators

`ep_companies`, `ei_activities_overview`, `mapper_ep_ei`, `ei_input_data`, and
`isic_4digit_name` are the five datasets which are used as the input for the
tiltIndicatorAfter package. They all are the output from tiltIndicatorBefore
package. These five datasets are used for adding additional data to all the four
indicators (Emissions profile, Emissions profile upstream, Sector profile,
Sector profile upstream).

```{r}
# ep_companies
europages_campanies <- read_csv("/path/ep_companies.csv") |>
  select("company_name", "country", "company_city", "postcode", "address", "main_activity", "companies_id")

# ecoinvent_activities
ei_activities_ov <- read_csv("/path/ei_activities_overview.csv")

# matches_mapper
mapper_ep_ei <- read_csv("/path/mapper_ep_ei.csv")

# ecoinvent_inputs
ei_input <- read_csv("/path/ei_input_data.csv") |>
  select("input_activity_uuid_product_uuid", "exchange_name", "exchange_unit_name") |> distinct()

# isic_4digit_name
isic_4digit_name <- read_csv("/path/isic_4digit_name.csv")
```

## Emissions profile

### Load Data

The input data of Emissions_profile which comes from tiltIndicatorBefore package
becomes the input for the tiltIndicator package.

```{r}
# emissions_profile companies
ep_company <- read_csv("/path/emissions_profile_any_companies_ecoinvent.csv")

# emissions_profile products
ep_product <- read_csv("/path/emissions_profile_products_ecoinvent.csv")
```

### Create Emissions_profile product and company level outputs

The code takes the output of tiltIndicator and use it as an input for the
tiltIndicatorAfter package.

```{r}
emissions_profile <- profile_emissions(ep_company,
                              ep_product,
                              europages_companies = europages_campanies,
                              ecoinvent_activities = ei_activities_ov,
                              ecoinvent_europages = mapper_ep_ei,
                              isic_tilt = isic_4digit_name,
                              low_threshold = 1 / 3,
                              high_threshold = 2 / 3)

emissions_profile_at_product_level <- emissions_profile |> unnest_product()
emissions_profile_at_company_level <- emissions_profile |> unnest_company()
```

### Save the Emissions profile final results

```{r}
emissions_profile_at_product_level |>
  write_csv("/path/emissions_profile_at_product_level.csv")

emissions_profile_at_company_level |>
  write_csv("/path/emissions_profile_at_company_level.csv")
```

## Emissions Profile Upstream

### Load Data

The input data of Emissions Profile Upstream which comes from
tiltIndicatorBefore package becomes the input for the tiltIndicator package.

```{r}
epu_company <- read_csv("/path/emissions_profile_any_companies_ecoinvent.csv")

epu_product <- read_csv("/path/emissions_profile_upstream_products_ecoinvent.csv")
```

### Create Emissions profile upstream product and company level outputs

The code takes the output of tiltIndicator and use it as an input for the
tiltIndicatorAfter package.

```{r}
emissions_profile_upstream <- profile_emissions_upstream(epu_company,
                              epu_product,
                              europages_companies = europages_campanies,
                              ecoinvent_activities = ei_activities_ov,
                              ecoinvent_inputs = ei_input,
                              ecoinvent_europages = mapper_ep_ei,
                              isic_tilt = isic_4digit_name,
                              low_threshold = 1 / 3,
                              high_threshold = 2 / 3)

emissions_profile_upstream_at_product_level <- emissions_profile_upstream |> unnest_product()
emissions_profile_upstream_at_company_level <- emissions_profile_upstream |> unnest_company()
```

### Save the Emissions profile upstream final results

```{r}
emissions_profile_upstream_at_product_level |>
  write_csv("/path/emissions_profile_upstream_at_product_level.csv")

emissions_profile_upstream_at_company_level |>
  write_csv("/path/emissions_profile_upstream_at_company_level.csv")
```

## Sector Profile

### Load Data

The input data of Sector Profile which comes from tiltIndicatorBefore package
becomes the input for the tiltIndicator package.

```{r}
sp_company <- read_csv("/path/sector_profile_companies.csv")

sp_scenarios <- read_csv("/path/sector_profile_any_scenarios.csv")
```

### Create Sector profile product and company level outputs

The code takes the output of tiltIndicator and use it as an input for the
tiltIndicatorAfter package.

```{r}
sector_profile <- profile_sector(sp_company,
                              sp_scenarios,
                              europages_companies = europages_campanies,
                              ecoinvent_activities = ei_activities_ov,
                              ecoinvent_europages = mapper_ep_ei,
                              isic_tilt = isic_4digit_name,
                              low_threshold = 1 / 3,
                              high_threshold = 2 / 3)

sector_profile_at_product_level <- sector_profile |> unnest_product()
sector_profile_at_company_level <- sector_profile |> unnest_company()
```

### Save the Sector profile final results

```{r}
sector_profile_at_product_level |>
  write_csv("/path/sector_profile_at_product_level.csv")

sector_profile_at_company_level |>
  write_csv("/path/sector_profile_at_company_level.csv")
```

## Sector profile upstream

### Load Data

The input data of Sector profile upstream which comes from tiltIndicatorBefore
package becomes the input for the tiltIndicator package.

```{r}
spu_company <- read_csv("/path/sector_profile_upstream_companies.csv")

spu_product <- read_csv("/path/sector_profile_upstream_products.csv")

spu_scenarios <- read_csv("/path/sector_profile_any_scenarios.csv")
```

### Create Sector profile upstream product and company level outputs.

The code takes the output of tiltIndicator and use it as an input for the
tiltIndicatorAfter package.

```{r}
sector_profile_upstream <- profile_sector_upstream(spu_company,
                              spu_scenarios,
                              spu_product,
                              europages_companies = europages_campanies,
                              ecoinvent_activities = ei_activities_ov,
                              ecoinvent_inputs = ei_input,
                              ecoinvent_europages = mapper_ep_ei,
                              isic_tilt = isic_4digit_name,
                              low_threshold = 1 / 3,
                              high_threshold = 2 / 3)

sector_profile_upstream_at_product_level <- sector_profile_upstream |> unnest_product()
sector_profile_upstream_at_company_level <- sector_profile_upstream |> unnest_company()
```

### Save the Sector profile upstream final results

```{r}
sector_profile_upstream_at_product_level |>
  write_csv("/path/sector_profile_upstream_at_product_level.csv")

sector_profile_upstream_at_company_level |>
  write_csv("/path/sector_profile_upstream_at_company_level.csv")
```
